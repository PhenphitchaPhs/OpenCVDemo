<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion Detection - Debug Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #111; color: white; }
        #canvasOutput { border: 3px solid #00ff00; background: #000; width: 100%; max-width: 640px; }
        #status { background: #333; padding: 10px; margin-bottom: 10px; color: #00ff00; }
    </style>
</head>
<body>
    <h2>AI Emotion Detection (Debug)</h2>
    <div id="status">กำลังรอการตอบสนองจากกล้อง...</div>

    <div class="view-box">
        <video id="videoInput" width="640" height="480" autoplay playsinline style="display:none;"></video>
        <canvas id="canvasOutput" width="640" height="480"></canvas>
    </div>

    <script>
        const video = document.getElementById('videoInput');
        const canvas = document.getElementById('canvasOutput');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        let session;

        // 1. เปิดกล้องทันทีที่โหลดหน้าเว็บ
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.innerText = "กล้องทำงานแล้ว! กำลังโหลดโมเดล AI...";
                renderFrame();
                loadModel();
            } catch (err) {
                status.innerText = "เข้าถึงกล้องไม่ได้: " + err.message;
                status.style.color = "red";
            }
        }

        // 2. วาดภาพลงจออย่างต่อเนื่อง
        function renderFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // วาดกรอบสแกนหน้า
            ctx.strokeStyle = "#00ff00";
            ctx.strokeRect(220, 140, 200, 200);
            
            requestAnimationFrame(renderFrame);
        }

        // 3. โหลดโมเดลทีหลังเพื่อไม่ให้ขัดขวางการเปิดกล้อง
        async function loadModel() {
            try {
                // เช็คชื่อไฟล์ให้ตรงกับ emotion_yolo11n_cls.onnx ใน GitHub
                session = await ort.InferenceSession.create('./emotion_yolo11n_cls.onnx');
                status.innerText = "โมเดลโหลดเสร็จแล้ว! AI พร้อมทำงาน";
            } catch (e) {
                status.innerText = "โหลดโมเดลไม่สำเร็จ (เช็คชื่อไฟล์ใน GitHub): " + e.message;
                status.style.color = "orange";
            }
        }

        window.onload = startCamera;
    </script>
</body>
</html>
