<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion Detection Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="./opencv.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; }
        .video-container { position: relative; display: inline-block; }
        #canvasOutput { position: absolute; top: 0; left: 0; }
        #status { color: #00ff00; margin: 10px; }
    </style>
</head>
<body>
    <h1>AI Emotion Detection</h1>
    <p id="status">ระบบกำลังเริ่มทำงาน...</p>
    
    <div class="video-container">
        <video id="videoInput" width="640" height="480" autoplay playsinline style="display:none;"></video>
        <canvas id="canvasOutput" width="640" height="480"></canvas>
    </div>

    <script>
        let session;
        let labels = [];

        async function loadModel() {
            try {
                // 1. โหลดชื่ออารมณ์จาก classes.json
                const res = await fetch('./classes.json');
                labels = await res.json();

                // 2. โหลดโมเดล ONNX
                session = await ort.InferenceSession.create('./emotion_yolo11n_cls.onnx');
                document.getElementById('status').innerText = "AI พร้อมแล้ว! ส่องหน้าได้เลย";
                startVideo();
            } catch (e) {
                document.getElementById('status').innerText = "โหลดไม่สำเร็จ: " + e.message;
            }
        }

        function startVideo() {
            const video = document.getElementById('videoInput');
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    processVideo();
                };
            });
        }

        async function processVideo() {
            const video = document.getElementById('videoInput');
            const canvas = document.getElementById('canvasOutput');
            const ctx = canvas.getContext('2d');

            if (video.paused || video.ended) return;

            // วาดภาพจากวิดีโอลง Canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // --- ส่วนประมวลผล AI ---
            // หมายเหตุ: สำหรับโมเดล Classification (cls) 
            // ระบบจะทายอารมณ์จากภาพทั้งเฟรมหรือจุดที่เด่นที่สุด
            try {
                // เตรียมข้อมูลภาพส่งให้โมเดล
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                // (โค้ดจำลองการพยากรณ์เบื้องต้น)
                // ผลลัพธ์จะแสดงเป็นข้อความบนหน้าจอ
                ctx.strokeStyle = "#00ff00";
                ctx.lineWidth = 4;
                ctx.strokeRect(200, 100, 240, 240); // วาดกรอบจำลอง
                ctx.fillStyle = "#00ff00";
                ctx.font = "30px Arial";
                ctx.fillText("Emotion: Detecting...", 200, 90);
            } catch (err) {
                console.error(err);
            }

            requestAnimationFrame(processVideo);
        }

        // รอจน OpenCV พร้อมใช้งาน
        if (typeof cv !== 'undefined') {
            loadModel();
        } else {
            window.onload = loadModel;
        }
    </script>
</body>
</html>
