<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion Detection Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #000; color: #fff; }
        .view-box { position: relative; display: inline-block; margin-top: 20px; }
        #canvasOutput { border: 2px solid #00ff00; border-radius: 8px; }
        #status { font-weight: bold; padding: 10px; color: #00ff00; }
    </style>
</head>
<body>
    <h1>AI Emotion Detection</h1>
    <div id="status">กำลังรอระบบ...</div>

    <div class="view-box">
        <video id="videoInput" width="640" height="480" autoplay playsinline style="display:none;"></video>
        <canvas id="canvasOutput" width="640" height="480"></canvas>
    </div>

    <script>
        async function runAI() {
            const status = document.getElementById('status');
            const video = document.getElementById('videoInput');
            const canvas = document.getElementById('canvasOutput');
            const ctx = canvas.getContext('2d');

            try {
                // 1. โหลดโมเดล
                status.innerText = "กำลังโหลดโมเดล: emotion_yolo11n_cls.onnx";
                const session = await ort.InferenceSession.create('./emotion_yolo11n_cls.onnx');

                // 2. เปิดกล้อง
                status.innerText = "กำลังเปิดกล้อง...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;

                // 3. เริ่มวาดภาพและตรวจจับ
                status.innerText = "ระบบกำลังทำงาน!";
                
                function renderFrame() {
                    if (video.paused || video.ended) return;
                    
                    // วาดภาพจากวิดีโอลงบน Canvas ทุกๆ เฟรม
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // วาดกรอบสี่เหลี่ยมกลางจอ (ไกด์ไลน์สำหรับส่องหน้า)
                    ctx.strokeStyle = "#00ff00";
                    ctx.lineWidth = 3;
                    ctx.strokeRect(220, 140, 200, 200);
                    
                    ctx.fillStyle = "#00ff00";
                    ctx.font = "20px Arial";
                    ctx.fillText("วางใบหน้าในกรอบ", 250, 130);

                    // สั่งให้รันฟังก์ชันนี้ซ้ำในเฟรมถัดไป
                    requestAnimationFrame(renderFrame);
                }
                
                renderFrame();

            } catch (err) {
                status.style.color = "red";
                status.innerText = "เกิดข้อผิดพลาด: " + err.message;
                console.error(err);
            }
        }

        // เริ่มเมื่อโหลดไฟล์ทั้งหมดเสร็จ
        window.onload = () => {
            setTimeout(runAI, 2000); // รอ 2 วินาทีเพื่อให้ OpenCV พร้อม
        };
    </script>
</body>
</html>
